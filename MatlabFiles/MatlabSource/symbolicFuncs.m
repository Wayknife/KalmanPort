%% Compute Sybolic Representation of Quadrotor Dynamics (14 Dimension EKF)
%  Fredy Monterroza

X = sym('X', [14 1]); %State Vector: [pos vel orientation timeVaryingAccelBias constantBiasPhiTheta]
V = sym('V', [6 1]); %Accelerometer Input
%errX = sym('errX', [6 1]); %delta, that gets added to z = h(x) + delta
errV = sym('errV', [9 1]); %IMU Error + time varying bias
deltaT = sym('deltaT');

temp1 = RPYToRotMat(X(7:9)); %7-9 = roll, pitch, yaw
temp2 = (V + errV(1:6)) * deltaT;


%Compute the Process Equation and Corresponding Jacobians

g = [X(1:3) + X(4:6)*deltaT + (((temp1 * (V(1:3)-X(10:12)+errV(1:3))) - [.4109;.4024;9.6343])*deltaT^2/2); ...
    X(4:6) + (((temp1 * (V(1:3)-X(10:12)+errV(1:3))) - [.4109;.4024;9.6343])*deltaT); ...
     RotMatToRPY(temp1 * RPYToRotMat(temp2(4:6))); ...
     X(10:12) + (errV(7:9)*deltaT); ...
     X(13:14)]; 
g = simplify(g); %14x1
gEqn = matlabFunction(g);
 

G = jacobian(g, X); %14x14
L = jacobian(g, errV); %14x9

gFunc = matlabFunction(G);
lFunc = matlabFunction(L);


%{
%Note: For First Sample, i = 523

deltaT =

    0.0210
U =

   -0.1334
   -0.0098
    9.3744
    0.0540
   -0.1100
   -0.0140

Xn =

  Columns 1 through 10

   -0.1976    0.0798    0.8739   -0.3618    0.3644    0.1071    0.0037   -0.0003    1.5397         0

  Columns 11 through 14

         0         0         0         0

Vn =

   -0.1334   -0.0098    9.3744    0.0540   -0.1100   -0.0140

errVn =

         0         0         0         0         0         0   -0.0185    0.0016    0.0031

G =

  Columns 1 through 10

    1.0000         0         0    0.0210         0         0   -0.0000   -0.0021    0.0000   -0.0000
         0    1.0000         0         0    0.0210         0    0.0021         0    0.0000    0.0002
         0         0    1.0000         0         0    0.0210   -0.0000   -0.0000   -0.0000   -0.0000
         0         0         0    1.0000         0         0   -0.0000   -0.1970    0.0028   -0.0007
         0         0         0         0    1.0000         0    0.1970         0    0.0003    0.0210
         0         0         0         0         0    1.0000   -0.0035   -0.0002   -0.0000   -0.0001
         0         0         0         0         0         0    1.0000         0   -0.0012         0
         0         0         0         0         0         0   -0.0000    1.0000    0.0023         0
         0         0         0         0         0         0    0.0012         0    1.0000         0
         0         0         0         0         0         0         0         0         0    1.0000
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0

  Columns 11 through 14

   -0.0002   -0.0000         0         0
   -0.0000   -0.0000         0         0
    0.0000   -0.0002         0         0
   -0.0210   -0.0000         0         0
   -0.0007   -0.0001         0         0
    0.0000   -0.0210         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
    1.0000         0         0         0
         0    1.0000         0         0
         0         0    1.0000         0
         0         0         0    1.0000



L =

    0.0000    0.0002    0.0000         0         0         0         0         0         0
   -0.0002    0.0000    0.0000         0         0         0         0         0         0
    0.0000   -0.0000    0.0002         0         0         0         0         0         0
    0.0007    0.0210    0.0000         0         0         0         0         0         0
   -0.0210    0.0007    0.0001         0         0         0         0         0         0
    0.0001   -0.0000    0.0210         0         0         0         0         0         0
         0         0         0    0.0007    0.0210         0         0         0         0
         0         0         0   -0.0210    0.0007         0         0         0         0
         0         0         0    0.0000    0.0000    0.0210         0         0         0
         0         0         0         0         0         0    0.0210         0         0
         0         0         0         0         0         0         0    0.0210         0
         0         0         0         0         0         0         0         0    0.0210
         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0


Z =

   -0.1808
    0.0950
    0.8755
    0.0080
   -0.0035
    1.5398


K =

   1.0e-03 *

    0.0024    0.0000    0.0000         0         0         0
    0.0000    0.0024    0.0000         0         0         0
    0.0000    0.0000    0.0005         0         0         0
    0.2321    0.0000    0.0000         0         0         0
    0.0000    0.2321    0.0001         0         0         0
    0.0001    0.0007    0.0522         0         0         0
         0         0         0    0.4416   -0.0000    0.0005
         0         0         0   -0.0000    0.0152   -0.0006
         0         0         0    0.0005   -0.0000    0.4416
         0         0         0         0         0         0
         0         0         0         0         0         0
         0         0         0         0         0         0
         0         0         0         0         0         0
         0         0         0         0         0         0


Xest =

   -0.2053
    0.0874
    0.8761
   -0.3707
    0.3595
    0.1016
    0.0014
   -0.0015
    1.5394
   -0.0004
    0.0000
    0.0001
         0
         0



P =

   1.0e-04 *

  Columns 1 through 10

    0.0000    0.0000    0.0000    0.0023    0.0000    0.0000         0         0         0         0
    0.0000    0.0000    0.0000    0.0000    0.0023    0.0000         0         0         0         0
    0.0000    0.0000    0.0000    0.0000    0.0000    0.0042         0         0         0         0
    0.0023    0.0000    0.0000    0.2209    0.0000    0.0001         0         0         0         0
    0.0000    0.0023    0.0000    0.0000    0.2209    0.0007         0         0         0         0
    0.0000    0.0000    0.0042    0.0001    0.0007    0.3976         0         0         0         0
         0         0         0         0         0         0    0.0044   -0.0000    0.0000         0
         0         0         0         0         0         0   -0.0000    0.0044   -0.0000         0
         0         0         0         0         0         0    0.0000   -0.0000    0.0044         0
         0         0         0         0         0         0         0         0         0    0.2209
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0
         0         0         0         0         0         0         0         0         0         0

  Columns 11 through 14

         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
         0         0         0         0
    0.2209         0         0         0
         0    0.3976         0         0
         0         0         0         0
         0         0         0         0

normP =

   1.0e-04 *

         0    0.3976

%}


















